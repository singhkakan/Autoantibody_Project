---
title: "Serum_Autoantibody_2021"
knit: (function(input_file, encoding) {
    out_dir <- 'docs';
    rmarkdown::render(input_file,
      encoding=encoding,
      output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "ShrutiSinghKakan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Loading the libraries, message=FALSE, warning=FALSE}

library(car)
library(lsmeans)
library(calibrate)
library(dplyr)
#library(DEGreport)
library(DESeq2)
library(DEFormats)
library(edgeR)
library(emmeans)
library(ggpubr)
library(ggsci)
library(ggplot2)
library(gridExtra)
library(pheatmap)
library(reshape2)
library(RColorBrewer)
library(scales)
library(rstatix)
library(tidyr)
library(magrittr)
library(PCAtools)
library(tidyverse)
library(Biobase)
library(marray)
library(limma)
library(gplots)
```

##### 0 Dataset ######
```{r Dataset}
data <- read.csv("../../SerumAntibodies_2021/IgG_MCF_SH_179_raw.csv",  header=T, row.names = 1)
#Columns 16-47 are empty and are therefore removed
data <- as.data.frame((data))[,-c(16:47)]

#Creating metadata including Strain and age
Strain <- c(rep(c("BALBc", "NOD"), each=6), rep(c("NOD"), each=3))
Age <- c(rep(c("8wks", "28wks"), each=3), rep(c("8wks", "24wks", "33wks"), each=3))
Group <- c(rep(c("A","B","C","D","E"), each=3))
colData <- as.data.frame(cbind(c('B1_8', 'B2_8', 'B3_8', 'B1_28', 'B2_28', 'B3_28', 'N1_8', 'N2_8', 'N3_8', 'N1_24', 'N2_24', 'N3_24', 'N1_33', 'N2_33', 'N3_33'), Strain, Age, Group))
colnames(colData) <- c('Sample', "Strain", "Age", "Group")
rownames(colData) <- colData$Sample
colnames(data) <- colData$Sample

colData$Strain <- factor(colData$Strain)
colData$Strain <- relevel(colData$Strain, ref = "BALBc")
colData$Age <- factor(colData$Age, levels = c("8wks", "24wks", "28wks", "33wks"))
colData$Age <- relevel(colData$Age, ref='8wks')

```

###### 1 Visualizing raw data ###########
```{r Visualization}
#Boxplot of raw Signal Distribution, not normalized

mydata<-as.matrix(log2(data+0.5))

boxplot(as.data.frame(mydata),main="Signal distribution, Not normalized",xlab="Samples",ylab="Log2 Intensity",cex=0.8)


```

######2 Clustering samples based on Pearson correlation ############

```{r Sample Clustering}
matcor<-cor(mydata)
range(as.vector(matcor))

strain<-as.character(as.numeric(colData$Strain))
age<-as.character(as.numeric(colData$Age))

library(gplots)
heatmap.2(matcor,trace="none",col=heat.colors(40),ColSideColors=strain,
          RowSideColors=age, cexCol=1,cexRow=1,labCol="")
```

###### 3 Data Normalization ########
```{r Log2 Data normalization and visualization}
mydata <- as.matrix((data))
dataN <- (mydata[1:95,]/mydata[96,] * 100) #df with all rows
dataN <- mydata
boxplot(as.data.frame(log2(dataN+0.5)),main="Signal distribution, Not normalized",xlab="Samples",ylab="Log2 Intensity",cex=0.8)

library(matrixStats) #for function rowmedians
IgG_SNR <- read.csv("../../SerumAntibodies_2021/IgG_MCF_SNR.csv",  header=T, row.names = 1)[,1:15]
IgG_SNR$average <- rowMeans(IgG_SNR)
IgG_SNR$med <- rowMedians(as.matrix(IgG_SNR))
mydata <- data[which(IgG_SNR$average>3),] #filtering rows with high noise (i.e., rows with Signal to Noise Ratio or SNR > 3)
mydata<-as.matrix(mydata)
dataN <- (mydata[1:69,]/mydata[70,]) * 100
dataN <- mydata
boxplot(as.data.frame(log2(dataN+0.5)),main="Signal distribution, Not normalized SNR>3",xlab="Samples",ylab="Log2 Intensity",cex=0.8)
library(limma) #for function plotMDS
plotMDS(log2(dataN+0.5))
mm <- model.matrix(~0 + Group)
y <- voom((dataN), mm, plot = T)
```


```{r Density plots}
countData = as.data.frame(dataN)

df_dseq = melt(countData, variable.name = "Samples", value.name = "count") # reshape the matrix 
df_dseq = data.frame(df_dseq, Condition = substr(df_dseq$Samples,1,1))
mycolors <- colorRampPalette(brewer.pal(8, "Set1"))(13)

ggplot(df_dseq, aes(x = log10(count+0.5), colour = Samples, fill = Samples)) + 
   geom_density(alpha = 0, size = 0.8) + 
   facet_wrap(~Condition, ncol=3) #+
   #theme_minimal() + xlim(-1.5,6) +
   #scale_colour_manual(values=mycolors, name="") + guides(fill="none")

boxplot(as.data.frame(log10(dataN+0.5)),main="IgG normalization",col=strain)
boxplot(as.data.frame(log10(dataN+0.5)),main="NSI*SNR", col=strain)

mydata <- as.matrix((data+1))
dataN <- mydata #1
dataN <- (mydata[1:95,]/mydata[96,] * 100) #2
dataN <- as.matrix(log10(dataN+1)) #1 and 2
matcor<-cor(dataN)
range(as.vector(matcor))
strain<-as.character(as.numeric(colData$Strain))
age<-as.character(as.numeric(colData$Age))
heatmap.2(matcor,trace="none",col=heat.colors(40),ColSideColors=strain,RowSideColors=age, cexCol=1,cexRow=1,labCol="")
```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```
