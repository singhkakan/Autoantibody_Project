---
title: "Tear and Serum IgG Autoantibodies - NOR mice"
author: "ShrutiSinghKakan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(car)
library(lsmeans)
library(calibrate)
library(dplyr)
#library(DEGreport)
library(DESeq2)
library(DEFormats)
library(edgeR)
library(ggpubr)
library(ggsci)
library(ggplot2)
library(gridExtra)
library(pheatmap)
library(reshape2)
library(RColorBrewer)
library(scales)
library(rstatix)
library(tidyr)
library(magrittr)
library(PCAtools)
library(tidyverse)
library(Biobase)
library(marray)
library(limma)
library(gplots)

library(devtools)
#install_github("dpgaile/AutoAntArrayExmpl")
library(AutoAntArrayExmpl)

library(devtools)
#install_github("dpgaile/AutoAntArrayExmpl")
#devtools::install_github('renozao/NMF@devel')
library(AutoAntArrayExmpl)
library(NMF)
library(quantreg)
library(asbio)
library(fdrtool)
library(discreteMTP)
library(scales)
library(ggsci)
library(ggplot2)
```

#### Loading Raw datasets and creating meta-data df
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
IgG_NSI <- read.csv("../../Tear_Autoantibodies_2021/IgG_MCF_SH_292_NSI_nor.csv",  header=T, row.names = 1)[1:120,1:15]
IgG_SNR <- read.csv("../../Tear_Autoantibodies_2021/IgG_MCF_SH_292_SNR.csv",  header=T, row.names = 1)[1:120,1:15]
IgG_SNR$average <- rowMeans(IgG_SNR)
IgG_SNR$med <- rowMedians(as.matrix(IgG_SNR))
IgG_NSI <- IgG_NSI[which(IgG_SNR$med>3),]
IgG_SNR <- IgG_SNR[which(IgG_SNR$med>3),]
IgG_raw=list()
IgG_raw$NSI <- as.matrix(IgG_NSI)
IgG_raw$SNR <- as.matrix(IgG_SNR)[,1:15]

Strain <- c(rep(c("NOR", "BALBc"), each=3), rep(c("NOR"), each=6), rep(c("BALBc"), each=3))
Biofluid <- c(rep("Tears",6), rep("Serum", 9))
colData <- as.data.frame(cbind(c(colnames(IgG_NSI)), Strain, Biofluid))
colnames(colData) <- c('Sample', "Strain", "Biofluid")
rownames(colData) <- colData$Sample

colData$Strain <- factor(colData$Strain)
colData$Strain <- relevel(colData$Strain, ref = "BALBc")
colData$Biofluid <- factor(colData$Biofluid, levels = c("Tears", "Serum"))

```

#### Raw Data Visualizations
```{r Centering and Scaling Data, message=FALSE, warning=FALSE, paged.print=FALSE}
clrs=c(rep(pal_jco("default")(4)[1:2], each=3), rep(pal_jco("default")(4)[3], each=6), rep(pal_jco("default")(4)[4], each=3))
pchs=c(rep(2,3),rep(4,3), rep(5,6), rep(8,3))

#Centering and Scaling Differences Across Features
# Tukey Tri-mean for location
TriMnG=RowTriMeans(IgG_raw$NSI) # 99 elements (same as num of rows in NSI)
# Biweight midvariance for spread
bw.estG=unlist(apply(IgG_raw$NSI,1,r.bw)) # 99 elements

```

## Normalization
### First Stage with visualizations
```{r Normalization - I, message=FALSE, warning=FALSE, paged.print=FALSE}
#enable to background correct
IgG_raw$NSI <- as.matrix(IgG_NSI)
IgG_raw$NSI=IgG_raw$NSI*IgG_raw$SNR ##NSI changed permanently
IgG_raw$X_norm_1=IgG_raw$NSI
eps=.10
IgG_raw$QregFits=array(NA,dim=c(99,2))
TriMn=RowTriMeans(IgG_raw$X_norm_1) #new NSI Tukey tri mean
ResMat=c(IgG_raw$X_norm_1,IgG_raw$X_norm_1)-matrix(rep(TriMn,30),ncol=30) #New_NSI - NewNSI_TriMn 
SubMat=abs(ResMat)<quantile(as.vector(abs(ResMat)),prob=1-eps)

par(mfrow=c(2,2));par(mgp=c(1.5,.5,0));par(mar=c(2.75,2.75,1.5,0.25))
plot(rep(TriMn,30),as.vector(ResMat),
     xlim=quantile(TriMn,prob=c(0,.8)),
     ylim=quantile(as.vector(ResMat),prob=c(0.05,.95)),
     type="n",xlab="Raw Signal Tri-Mean",ylab="Raw Signal",
     main="IgG Raw Signal")
for(j in 1:15){
   points(TriMn,ResMat[,j],cex=0.5,pch=pchs[j],col=clrs[j])
   points(TriMn,ResMat[,15+j],cex=0.5,pch=pchs[j],col=clrs[j])
   y=c(ResMat[,j], ResMat[,15+j])
   x=c(TriMn, TriMn)
   fitj <- rq(y ~ x, tau = .5,subset=which(c(SubMat[,j], SubMat[,15+j])))
   abline(coef(fitj),col=clrs[j])
   IgG_raw$QregFits[j,]=coef(fitj)
   prdct=coef(fitj)[1]+coef(fitj)[2]*TriMn
   IgG_raw$X_norm_1[,j]=IgG_raw$X_norm_1[,j]-prdct
} ###substracting the model fit straight line from the data
#Xnorm_1 here is the residual value
```


```{r Normalization -I continued, message=FALSE, warning=FALSE, paged.print=FALSE}
eps=0.10
q.eps=0.10
lambda=.10 # incremental change
nitr=75 # number of iterations -> this should help us optimize the lambda for best fit
sad=rep(0,nitr) # sum of absolute deviations
# re-init
IgG_raw$X_1step_norm_1=IgG_raw$X_norm_1 #calculated in the last loop
IgG_raw$X_norm_1=IgG_raw$NSI #reinitializing

for(i in 1:nitr){
   # snoop and grab invariants
   X=IgG_raw$X_norm_1
   iWRS=function(i) t.test(X[i,c(1:3,7:12)],X[i,c(4:5,13:15)])$p.value
   qMat=matrix(rep(mapply(iWRS,1:99),30),ncol=30)
   qMat[which(is.na(qMat[,1])==T),] <- 0 #all NANs replaced by 0
   qcut=quantile(qMat[,1],prob=q.eps)
   
   TriMn=RowTriMeans(IgG_raw$X_norm_1)
   ResMat=c(IgG_raw$X_norm_1,IgG_raw$X_norm_1)-matrix(rep(TriMn,30),ncol=30)
   SubMat=abs(ResMat)<quantile(as.vector(abs(ResMat)),prob=1-eps) #all residuals with absolute values less than the cutoff of 90%
   SubMat[qMat<qcut]=FALSE #which p values are greater than the cutoffs
   for(j in 1:15){
      y=c(ResMat[,j], ResMat[,15+j])
      x=c(TriMn, TriMn)
      fitj <- rq(y ~ x, tau = .5,subset=which(c(SubMat[,j], SubMat[,15+j])))
      prdct=coef(fitj)[1]+coef(fitj)[2]*TriMn
      IgG_raw$X_norm_1[,j]=IgG_raw$X_norm_1[,j]-lambda*prdct
      sad[i]=sad[i]+sum(abs(2*lambda*prdct))
   }###substracting the model fit straight line from the data
   #print(sad)
   #print(qcut)
}
par(mfrow(1,2))
plot(1:nitr,sad,main="iterative adj IgG")
smoothScatter(IgG_raw$X_1step_norm_1,IgG_raw$X_norm_1, nbin = 500)
abline(0,1,col="steelblue")
```

### Normalization Second Stage ########
```{r Normalization Stage II, message=FALSE, warning=FALSE, paged.print=FALSE}
deltaG=min(as.vector(IgG_raw$X_norm_1))
IgG_raw$W_1=log(IgG_raw$X_norm_1-deltaG+1)
# get resids..
W_1=IgG_raw$W_1
RW=RowTriMeans(W_1)
# get residual matrices
RW_MAT=matrix(rep(RW,dim(W_1)[2]),ncol=dim(W_1)[2])
W_1=W_1-RW_MAT

W=W_1
bw.est=unlist(apply(W,2,r.bw))
# now, rescale
for(j in 1:15){
   W_1[,j]=W_1[,j]/sqrt(bw.est[j])
}
# now, get new values..
IgG_raw$W_1=RW_MAT+W_1
```

#### Density Plot of Normalized Data ####
```{r Density Plot after Normalization, message=FALSE, warning=FALSE, paged.print=FALSE}

plot(density(log2(IgG_raw$W_1[,1]-min(IgG_raw$W_1))-6.66), main="(logW_1) ", sub=" . ", type="l")
for(j in 2:15) {
   dens<-density(log2(IgG_raw$W_1[,j]-min(IgG_raw$W_1))-6.66)
   lines(dens, cex=0.5,pch=pchs[j],col=clrs[j],cex.main=1)
} #165.4 = -1* min(IgG_raw$W_1); 6.25 = log2(max(IgG_raw$W_1))

```


#### Heatmap of Normalized Data ####
```{r Heatmap, fig.height=12, fig.width=9, message=FALSE, warning=FALSE, paged.print=FALSE}
RnkSmplW_1=matrix(nrow=99,ncol=15)
RnkSmplW_1[,1]=IgG_raw$W_1[,1]
for(j in 2:15) RnkSmplW_1[,j]=IgG_raw$W_1[,j]
for(i in 1:99) RnkSmplW_1[i,]=rank(RnkSmplW_1[i,])/(15)
colnames(RnkSmplW_1)=as.character((colData$Sample))
rownames(RnkSmplW_1) <- rownames(IgG_raw$W_1)

#tiff("fig8.tiff", units="in", width=6, height=14, res=500)   
pheatmap(RnkSmplW_1,annCol=factor(colData$Strain),main="Rank-it (Across Samples) Normalized Signal IgG",dist="euclidean",hclust="ward", cutree_rows = 6, cutree_cols = 3)
#dev.off()
```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```

